name: Deploy Detection Rules to Splunk

on:
  push:
    paths:
      - 'rules/**' # rules 폴더 내 파일이 수정될 때만 실행

jobs:
  deploy:
    runs-on: ubuntu-latest # GitHub 호스팅 러너 사용 (또는 Self-hosted 가능)
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Validate YAML Syntax
        run: |
          echo "룰 문법 검사 중..."
          # yamllint 등을 활용한 검사 로직 추가 가능

      - name: Deploy to Splunk API
        env:
          SPLUNK_URL: ${{ secrets.SPLUNK_URL }}
          SPLUNK_TOKEN: ${{ secrets.SPLUNK_TOKEN }}
        run: |
          echo "Splunk로 탐지 룰 전송 시작..."
          # rules 폴더 내의 모든 yml 파일을 읽어서 배포하는 스크립트 예시
          curl -k -u "admin:$SPLUNK_TOKEN" \
          "$SPLUNK_URL/services/saved/searches" \
          -d name="Detect_Whoami_Alert_v2" \
          -d search="index=main process_name=whoami" \
          -d alert_type="number of events" \
          -d alert_comparator="greater than" \
          -d alert_threshold="0" \
          -d cron_schedule="* * * * *" \
          -d "action.jira=1" # Jira 연동 액션 활성화