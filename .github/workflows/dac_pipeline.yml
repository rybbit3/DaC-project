name: End-to-End DaC Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  dev-sec-ops-cycle:
    runs-on: self-hosted  # [중요] 사용자 맥북에서 실행됨
    
    steps:
    # 1. 코드 최신화
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. 필수 라이브러리 설치 및 PATH 설정
    - name: Install Dependencies
      run: |
        pip3 install sigma-cli pyyaml requests
        
        # [핵심 수정] 파이썬 패키지 설치 경로를 Github Runner의 PATH에 영구 추가
        echo "$(python3 -m site --user-base)/bin" >> $GITHUB_PATH
        
        # 현재 단계에서도 즉시 쓸 수 있게 임시 적용
        export PATH=$PATH:$(python3 -m site --user-base)/bin
        
        # 플러그인 설치 (이제 sigma 명령어를 찾을 수 있음)
        sigma plugin install splunk || true

    # 3. [Build] Sigma 룰 -> Splunk 설정 변환
    - name: Build Splunk Config
      run: python3 pipeline.py

# 5. [Test] 공격 및 로그 주입
    - name: Execute Attack & Ingest Log
      run: |
        export PATH=$PATH:/opt/homebrew/bin:/usr/local/bin
        echo "⚔️ 공격 시뮬레이션 시작!"
        
        # 1. 공격 수행
        pwsh -Command "
          IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing);
          Install-AtomicRedteam -getAtomics -Force;
          Invoke-AtomicTest T1059.001 -TestNumbers 1
        "

        # 2. [핵심 수정] "Kitchen Sink" JSON 생성 (필드명 불일치 원천 봉쇄)
        # Sigma가 CommandLine을 찾든, command_line을 찾든, cmdline을 찾든 무조건 걸리게 다 넣습니다.
        echo '{
          "host": "github-runner",
          "user": "admin",
          "process_name": "pwsh",
          "Image": "pwsh",
          "process": "pwsh",
          "CommandLine": "Invoke-AtomicTest T1059.001 -TestNumbers 1",
          "command_line": "Invoke-AtomicTest T1059.001 -TestNumbers 1",
          "cmdline": "Invoke-AtomicTest T1059.001 -TestNumbers 1",
          "action": "allowed"
        }' > attack.json
        
        # 3. 로그 주입
        docker cp attack.json my-splunk-lab:/tmp/
        docker exec --user root my-splunk-lab chown splunk:splunk /tmp/attack.json
        docker exec --user splunk my-splunk-lab /opt/splunk/bin/splunk add oneshot /tmp/attack.json -index main -sourcetype _json -auth admin:admin1234

  # 5. [Test] 공격 및 로그 주입
    - name: Execute Attack & Ingest Log
      run: |
        export PATH=$PATH:/opt/homebrew/bin:/usr/local/bin
        echo "⚔️ 공격 시뮬레이션 시작!"
        
        # 1. 공격 수행 (설치 포함)
        pwsh -Command "
          IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing);
          Install-AtomicRedteam -getAtomics -Force;
          Invoke-AtomicTest T1059.001 -TestNumbers 1
        "

        # 2. [핵심] 로그에서 'timestamp' 제거! & JSON 포맷
        # 시간을 빼버리면 Splunk가 수신한 시간을 기준으로 인덱싱하므로 시차 문제 해결됨
        echo "{\"host\": \"github-runner\", \"user\": \"admin\", \"process_name\": \"pwsh\", \"command_line\": \"Invoke-AtomicTest T1059.001 -TestNumbers 1\", \"action\": \"allowed\"}" > attack.json
        
        # 3. 로그 주입
        docker cp attack.json my-splunk-lab:/tmp/
        docker exec --user root my-splunk-lab chown splunk:splunk /tmp/attack.json
        docker exec --user splunk my-splunk-lab /opt/splunk/bin/splunk add oneshot /tmp/attack.json -index main -sourcetype _json -auth admin:admin1234


    # 6. [Verify] 탐지 검증
    - name: Verify Detection
      run: |
        python3 verify.py