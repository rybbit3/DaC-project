name: End-to-End DaC Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  dev-sec-ops-cycle:
    runs-on: self-hosted  # [중요] 사용자 맥북에서 실행됨
    
    steps:
    # 1. 코드 최신화
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. 필수 라이브러리 설치 및 PATH 설정
    - name: Install Dependencies
      run: |
        pip3 install sigma-cli pyyaml requests
        
        # [핵심 수정] 파이썬 패키지 설치 경로를 Github Runner의 PATH에 영구 추가
        echo "$(python3 -m site --user-base)/bin" >> $GITHUB_PATH
        
        # 현재 단계에서도 즉시 쓸 수 있게 임시 적용
        export PATH=$PATH:$(python3 -m site --user-base)/bin
        
        # 플러그인 설치 (이제 sigma 명령어를 찾을 수 있음)
        sigma plugin install splunk || true

    # 3. [Build] Sigma 룰 -> Splunk 설정 변환
    - name: Build Splunk Config
      run: python3 pipeline.py

# 4. [Deploy] Docker 컨테이너로 배포 
    - name: Deploy to Splunk
      run: |
        # [수정 1] 권한 문제 원천 봉쇄 (Splunk 폴더 전체 소유권 변경)
        docker exec --user root my-splunk-lab chown -R splunk:splunk /opt/splunk
        
        # [핵심 해결책] 인시던트 저장용 Index 자동 생성
        # 컨테이너가 재성성되더라도 파이프라인이 알아서 인덱스를 만듭니다.
        # (이미 존재하면 에러가 날 수 있으니 || true 로 무시)
        docker exec --user splunk my-splunk-lab /opt/splunk/bin/splunk add index incidents -auth admin:admin1234 || true
        
        # 목적지 폴더 생성
        docker exec --user splunk my-splunk-lab mkdir -p /opt/splunk/etc/apps/search/local
        
        # 설정 파일 복사
        docker cp savedsearches.conf my-splunk-lab:/opt/splunk/etc/apps/search/local/
        
        # 복사된 파일 권한 재수정 (cp는 root로 들어가므로)
        docker exec --user root my-splunk-lab chown splunk:splunk /opt/splunk/etc/apps/search/local/savedsearches.conf
        
        # 재시작 (설정 적용)
        docker restart my-splunk-lab
        echo "⏳ Splunk 재시작 대기 중..."
        sleep 60

        
# 5. [Test] Atomic Red Team 공격 실행 & 로그 주입
    - name: Execute Attack & Ingest Log
      run: |
        export PATH=$PATH:/opt/homebrew/bin:/usr/local/bin
        echo "⚔️ 공격 시뮬레이션 시작!"
        
        # 1. 실제 공격 수행
        pwsh -Command "
          IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing);
          Install-AtomicRedteam -getAtomics -Force;
          Invoke-AtomicTest T1059.001 -TestNumbers 1
        "

        # 2. [수정] timestamp 필드 제거! (Timezone 문제 해결)
        # Splunk가 수신 시간을 기준으로 인덱싱하도록 합니다.
        echo "{\"host\": \"github-runner\", \"user\": \"admin\", \"process_name\": \"pwsh\", \"command_line\": \"Invoke-AtomicTest T1059.001 -TestNumbers 1\", \"action\": \"allowed\"}" > attack.json
        
        # 3. Splunk에 로그 주입
        docker cp attack.json my-splunk-lab:/tmp/
        docker exec --user root my-splunk-lab chown splunk:splunk /tmp/attack.json
        docker exec --user splunk my-splunk-lab /opt/splunk/bin/splunk add oneshot /tmp/attack.json -index main -sourcetype _json -auth admin:admin1234


    # 6. [Verify] 탐지 검증
    - name: Verify Detection
      run: |
        python3 verify.py