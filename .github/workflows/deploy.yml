name: Deploy Detection Rules to Splunk

on:
  push:
    paths:
      - 'rules/**'

jobs:
  deploy:
    runs-on: self-hosted  # <--- ubuntu-latest에서 변경
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        run: |
          # Self-hosted 환경에서는 python이 설치되어 있어야 합니다.
          python3 -m pip install requests pyyaml
  
      - name: Run Detection Test
        run: |
          # 1. 테스트용 로그 발생
          echo "SECURITY_ALERT: TEST_ATTACK_LOG" >> /tmp/test.log
          
          # 2. 잠시 대기 (Splunk가 인덱싱하고 룰이 돌아갈 시간)
          sleep 60
          
          # 3. Splunk API를 통해 해당 룰이 알람을 발생시켰는지 쿼리해서 확인
          # 알람 발생 기록이 없으면 배포 실패(exit 1) 처리
          python verify_alert.py
          
      - name: Deploy to Splunk
        env:
          SPLUNK_URL: "https://localhost:8089" # Runner가 로컬이므로 localhost 가능
          SPLUNK_PASSWORD: ${{ secrets.SPLUNK_PASSWORD }}
          JIRA_ACCOUNT: "rybbit3"
        run: python3 deploy.py