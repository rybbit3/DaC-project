import os
import subprocess
import yaml # pip install pyyaml

# [ì„¤ì •] ë£° íŒŒì¼ì´ ëª¨ì—¬ìˆëŠ” í´ë” ì´ë¦„ (í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ì¶¤)
RULE_DIR = "rules" 
OUTPUT_FILE = "savedsearches.conf"

def run_pipeline():
    print("ğŸš€ [Scenario] Incident Generator Pipeline ì‹œì‘...")
    
    # rules í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
    if not os.path.exists(RULE_DIR):
        print(f"âŒ Error: '{RULE_DIR}' í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ìœ„ì¹˜: {os.getcwd()}")
        exit(1) # ê°•ì œ ì‹¤íŒ¨ ì²˜ë¦¬

    # yml íŒŒì¼ ì°¾ê¸°
    yml_files = [f for f in os.listdir(RULE_DIR) if f.endswith('.yml')]
    
    if not yml_files:
        print(f"âš ï¸ ê²½ê³ : '{RULE_DIR}' í´ë”ì— .yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        # íŒŒì¼ì´ ì—†ì–´ë„ CI/CDê°€ ì£½ì§€ ì•Šê²Œ ë¹ˆ íŒŒì¼ì´ë¼ë„ ìƒì„±í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
        # open(OUTPUT_FILE, 'w').close()
        exit(1) # ì§€ê¸ˆì€ ì‹¤ìŠµì´ë‹ˆ íŒŒì¼ ì—†ìœ¼ë©´ ì—ëŸ¬ë¡œ ì²˜ë¦¬

    print(f"ğŸ“¦ ë°œê²¬ëœ ë£° íŒŒì¼: {len(yml_files)}ê°œ")
    
    with open(OUTPUT_FILE, 'w') as outfile:
        outfile.write("# Generated by Detection-as-Code Pipeline\n")
        outfile.write("# Creates Incidents in 'index=incidents'\n\n")

        for yml in yml_files:
            # [ì¤‘ìš”] íŒŒì¼ëª…ë§Œ ìˆìœ¼ë©´ ì•ˆ ë˜ê³ , ê²½ë¡œê¹Œì§€ í•©ì³ì•¼ í•¨!
            full_path = os.path.join(RULE_DIR, yml)
            
            try:
                # 1. ë©”íƒ€ë°ì´í„° ì½ê¸°
                with open(full_path, 'r') as f:
                    rule_content = yaml.safe_load(f)
                
                title = rule_content.get('title', 'Untitled Rule')
                description = rule_content.get('description', 'No description')
                
                # 2. Sigma ë³€í™˜ (ê²½ë¡œ í¬í•¨í•´ì„œ ì‹¤í–‰)
                cmd = ["sigma", "convert", "-t", "splunk", "--without-pipeline", full_path]
                
                result = subprocess.run(cmd, capture_output=True, text=True, check=True)
                query = result.stdout.strip()
                
                # 3. Splunk ì„¤ì • ì‘ì„±
                stanza = f"""
[{title}]
search = {query}
description = {description}
enable_sched = 1
cron_schedule = * * * * *
dispatch.earliest_time = -5m
dispatch.latest_time = now
action.summary_index = 1
action.summary_index._name = incidents
action.summary_index.report = {title}
alert.severity = 4
disabled = 0
"""
                outfile.write(stanza + "\n")
                print(f"âœ… Created Scenario: {title}")
                
            except subprocess.CalledProcessError as e:
                print(f"âŒ Sigma ë³€í™˜ ì‹¤íŒ¨ ({yml}): {e.stderr}")
                exit(1) # ë³€í™˜ ì‹¤íŒ¨ ì‹œ CI ì¤‘ë‹¨
            except Exception as e:
                print(f"âŒ ì¼ë°˜ ì—ëŸ¬ ({yml}): {e}")
                exit(1)

    print(f"\nâœ¨ [Success] '{OUTPUT_FILE}' ìƒì„± ì™„ë£Œ!")

if __name__ == "__main__":
    run_pipeline()